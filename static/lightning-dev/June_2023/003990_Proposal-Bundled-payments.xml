<?xml version='1.0' encoding='UTF-8'?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <id>1</id>
  <title>Proposal: Bundled payments</title>
  <updated>2023-07-04T02:59:33.488856+00:00</updated>
  <author>
    <name>SomberNight 2023-06-20 16:49:05+00:00</name>
  </author>
  <generator uri="https://lkiesow.github.io/python-feedgen" version="0.9.0">python-feedgen</generator>
  <entry>
    <id>1</id>
    <title>Proposal: Bundled payments</title>
    <updated>2023-07-04T02:59:33.488879+00:00</updated>
    <link href="https://lists.linuxfoundation.org/pipermail/lightning-dev/2023-June/003990.html" rel="alternate"/>
    <summary>One point emphasized in the context is that there are potentially three different entities involved in payments, which may not be obvious at first glance. The example given is the submarine swap scenario, where there are two entities (the user and the server), but in reality, there is a third entity, the swap service provider.It is important to note that the proposal requires senders to be aware that the payment will lead to a channel creation or a splice on the receiver's end. This requires all existing software used by senders to be updated.In the submarine swap scenario, there are three entities: Alice (the user), the swap service provider (server), and Bob (who wants to pay Alice via Lightning). Alice generates an invoice to receive money onchain, and Bob needs to implement a proposal that can parse an invoice with two payment hashes and corresponding amounts. Using a swap service, Bob can pay Alice on Lightning, and Alice receives the payment onchain.The process involves Alice generating a preimage and calculating its hash for the actual amount she wants to receive. Alice then contacts the swap server, providing the hash and amount. The server generates another preimage and hash for a small prepayment amount. The server creates a lightning invoice with both sets of hashes and amounts, which Alice checks before giving it to Bob. Bob sees the invoice contains two payment hashes and amounts and sends HTLCs to cover both. The server holds the HTLCs until it receives enough money for both the prepayment and the main payment. Once received, the server fulfills the HTLCs for the prepayment and creates a swap funding transaction onchain. Alice sees the transaction and waits for it to be mined before broadcasting a claim transaction using the preimage for the main payment. The server fulfills the still pending HTLCs for the main payment using this preimage.It's worth noting that Bob is a simple lightning wallet that needs to parse and pay the new type of LN invoice containing two hashes. All the security checks and swap logic are implemented on Alice's side. The drawback is that Bob, paying lightning, may have to wait for onchain transactions to be mined without knowing or needing to know about it.Additionally, instead of the special bolt11 invoice, Alice could create a bip21 URI containing both an onchain address and the lightning invoice. This gives Bob the choice of paying onchain or via lightning.Apart from swaps, another use case mentioned is JIT (Just-in-Time) channels. Similar to the swap example, Alice can negotiate with the service provider to have a JIT channel opened to her and forward the HTLC using that channel. Alice can wait for the channel funding to be mined before releasing the preimage for the main payment by fulfilling the HTLC offchain. Bob is unaware of what happens between the service provider and Alice and only experiences the delay in the fulfillment of the HTLC.In conclusion, the proposal suggests extending BOLT-11 to include a new feature where an invoice can contain two bundled payments with distinct preimages and amounts. This feature caters to services that require prepayment of mining fees for non-custodian exchanges like submarine swaps and JIT channels. The proposal requires senders to be aware of the channel creation or splice on the receiver's end and necessitates updating existing software. The implementation involves multiple entities, including the user, server, and service provider, with specific steps for generating preimages, creating invoices, and fulfilling HTLCs.In a recent discussion on the lightning-dev mailing list, ThomasV proposed a solution to address vulnerabilities in the Boltz lightning service. He highlighted the issue of double-spending invoices and the potential for denial-of-service (DoS) attacks that could force Boltz to pay on-chain fees.To protect against such attacks, ThomasV suggested implementing Just-In-Time (JIT) channels. These channels would require providers to request the preimage of the main payment before opening the channel, making them custodians by legal definition. However, this approach raises concerns regarding compliance with the European MICA regulation.To overcome these challenges, ThomasV proposed bundling the prepayment and main payment in the same BOLT-11 invoice. This approach would involve including two preimages and two amounts in the invoice. The receiver would need to wait for both payments' HTLCs to arrive before fulfilling the HTLCs of the prepayment. If the main payment fails to arrive, the pre-payment would be failed with a MPP timeout. Once both payments' HTLCs have arrived, the receiver can fulfill the HTLCs of the prepayment and broadcast the on-chain transaction. It's important to note that the main payment can still fail if the sender never reveals the preimage.ThomasV acknowledged that his proposal does not prevent service providers from stealing the prepayment but argued that this risk is already present. He believes that implementing bundled payments in BOLT-11 would level the playing field among lightning service providers</summary>
    <published>2023-06-20T16:49:05+00:00</published>
  </entry>
</feed>
