<?xml version='1.0' encoding='UTF-8'?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <id>2</id>
  <title>Combined summary - Potential vulnerability in Lightning backends: BOLT-11 "payment hash" does not commit to payment!</title>
  <updated>2023-07-02T03:20:27.764248+00:00</updated>
  <author>
    <name>callebtc 2023-06-19 15:26:05+00:00</name>
  </author>
  <author>
    <name>Antoine Riard 2023-06-19 20:34:10+00:00</name>
  </author>
  <link href="lightning-dev/June_2023/003983_Potential-vulnerability-in-Lightning-backends-BOLT-11-payment-hash-does-not-commit-to-payment-.xml" rel="alternate"/>
  <link href="lightning-dev/June_2023/003986_Potential-vulnerability-in-Lightning-backends-BOLT-11-payment-hash-does-not-commit-to-payment-.xml" rel="alternate"/>
  <generator uri="https://lkiesow.github.io/python-feedgen" version="0.9.0">python-feedgen</generator>
  <entry>
    <id>2</id>
    <title>Combined summary - Potential vulnerability in Lightning backends: BOLT-11 "payment hash" does not commit to payment!</title>
    <updated>2023-07-02T03:20:27.764292+00:00</updated>
    <link href="https://lists.linuxfoundation.org/pipermail/lightning-dev/2023-June/003983.html" rel="alternate"/>
    <summary>In a recent discovery, the LNbits team found an exploit that allows attackers to create balances out of thin air by manipulating invoices. This vulnerability has been patched in LNbits version 0.10.5, and users are urged to update their software. The team believes that similar exploits may be possible in other Lightning applications, particularly those used for custodial wallets, payment processors, and account management software.The attack works by inserting a bolt-11 payment hash from one payment (A) into a different payment (B), creating a malicious invoice (B) that tricks the backend into thinking B is equal to A. The process involves creating two invoices, A and B', deserializing B', inserting payment_hash(A) into payment_hash(B), re-signing the invoice, and then serializing it again to produce the malicious invoice B. The attacker then creates a new account and pays using invoice B.The LNbits backend uses payment_hash(B) to determine whether the payment is internal or via Lightning Network. Since the system assumes that payment_hash(A) commits to payment A, the backend finds A in its database. However, it is important to note that payment hashes do not commit to any payment details, such as the amount. The backend settles the payment internally by crediting A and debiting B, effectively allowing the attacker to "create" 999 satoshis.To mitigate this vulnerability, backends should use self-generated unique "checking ids" for internal payments or implement additional checks to ensure that invoice details have not been tampered with. For example, asserting that amount(A) is equal to amount(B) can provide an additional layer of security.This exploit highlights the sophistication of LN-savvy attackers, as it requires a deep understanding of bolt-11 and custom tooling to create the malicious invoice. Moreover, it emphasizes the need to clarify the purpose of the "payment hash" field in invoices. The LNbits team suggests referring to it as the "preimage hash" to avoid any implicit assumptions that the hash commits to payment details like amount or public key.In response to the report, Antoine explains that if custodial wallets, payment processors, or account management software are based on LDK and adhere to the API recommendations by using "create_inbound_payment," they should not be affected by this exploit. He also advises following good disclosure security practices by informing Lightning implementation maintainers in advance to facilitate patch coordination with second-line vendors.Overall, this discovery serves as a reminder for developers and users of Lightning applications to remain vigilant against potential vulnerabilities and to implement necessary security measures.</summary>
    <published>2023-06-19T15:26:05+00:00</published>
  </entry>
</feed>
