<?xml version='1.0' encoding='UTF-8'?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <id>2</id>
  <title>Combined summary - Potential vulnerability in Lightning backends: BOLT-11 "payment hash" does not commit to payment!</title>
  <updated>2023-06-30T03:03:47.686322+00:00</updated>
  <author>
    <name>callebtc 2023-06-19 15:26:05+00:00</name>
  </author>
  <author>
    <name>Antoine Riard 2023-06-19 20:34:10+00:00</name>
  </author>
  <link href="lightning-dev/June_2023/003983_Potential-vulnerability-in-Lightning-backends-BOLT-11-payment-hash-does-not-commit-to-payment-.xml" rel="alternate"/>
  <link href="lightning-dev/June_2023/003986_Potential-vulnerability-in-Lightning-backends-BOLT-11-payment-hash-does-not-commit-to-payment-.xml" rel="alternate"/>
  <generator uri="https://lkiesow.github.io/python-feedgen" version="0.9.0">python-feedgen</generator>
  <entry>
    <id>2</id>
    <title>Combined summary - Potential vulnerability in Lightning backends: BOLT-11 "payment hash" does not commit to payment!</title>
    <updated>2023-06-30T03:03:47.686360+00:00</updated>
    <link href="https://lists.linuxfoundation.org/pipermail/lightning-dev/2023-June/003983.html" rel="alternate"/>
    <summary>Earlier last month, the team at LNbits discovered an exploit that allowed attackers to create balances out of thin air by exploiting a quirk in how invoices are handled internally. This issue has been patched in LNbits version 0.10.5, and it is strongly recommended for users to update their software as soon as possible. The purpose of this message is to describe the attack so that developers working on custodial wallets, payment processors, account management software, and similar applications can be aware of the potential vulnerability.In summary, the attacker was able to create a malicious invoice by inserting the payment hash of one payment into a different payment. Here's a step-by-step breakdown of the attack:1. The attacker creates invoice A with an amount of 1000 sat in LNbits.2. The attacker also creates invoice B' with an amount of 1 sat on their own node.3. The attacker deserializes invoice B', replaces its payment hash with the payment hash from invoice A, re-signs the invoice, and serializes it again. This produces the malicious invoice B.4. The attacker then creates a new account in LNbits and pays invoice B.5. The LNbits backend uses the payment hash from invoice B to determine whether this is an internal payment or a payment via the Lightning Network.6. Since the backend assumes that the payment hash commits to the payment details, it finds invoice A in its database.7. The backend settles the payment internally by crediting invoice A and debiting invoice B, effectively creating 999 sats out of thin air.To mitigate this exploit, it is recommended that backends use self-generated unique "checking ids" for looking up internal payments or implement additional checks to ensure that the invoice details have not been tampered with. For example, verifying that the amounts in the original and modified invoices are the same.There are two important lessons to learn from this attack. Firstly, it highlights the level of sophistication of LN-savvy attackers who possess a deep understanding of bolt-11 and require custom tooling to execute such an exploit. Secondly, it emphasizes that the "payment hash" of an invoice is not a true "payment" hash but rather a "preimage" hash. This distinction is crucial to avoid developers mistakenly assuming that the hash commits to payment details like amount or pubkey.In response to this report, Antoine acknowledges the plausibility of the attack and provides information on how custodial wallets, payment processors, and account management software based on LDK can protect against it. He also mentions that issues with invoice safety have been previously known since CVE-2020-26896. Additionally, he advises following good disclosure security practices by notifying Lightning implementation maintainers in advance to facilitate patch coordination if needed with second-line vendors.Overall, it is important for developers and users alike to be aware of this exploit and take necessary measures to protect their systems and applications.</summary>
    <published>2023-06-19T15:26:05+00:00</published>
  </entry>
</feed>
